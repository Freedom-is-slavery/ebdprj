#include "stdio.h"
#include "wiringPi.h"
#include "MAX7219.h"

const uint8_t dismap[36][8] = {
    {0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C},      //0
    {0x10,0x18,0x14,0x10,0x10,0x10,0x10,0x10},      //1
    {0x7E,0x02,0x02,0x7E,0x40,0x40,0x40,0x7E},      //2
    {0x3E,0x02,0x02,0x3E,0x02,0x02,0x3E,0x00},      //3
    {0x08,0x18,0x28,0x48,0xFE,0x08,0x08,0x08},      //4
    {0x3C,0x20,0x20,0x3C,0x04,0x04,0x3C,0x00},      //5
    {0x3C,0x20,0x20,0x3C,0x24,0x24,0x3C,0x00},      //6
    {0x3E,0x22,0x04,0x08,0x08,0x08,0x08,0x08},      //7
    {0x00,0x3E,0x22,0x22,0x3E,0x22,0x22,0x3E},      //8
    {0x3E,0x22,0x22,0x3E,0x02,0x02,0x02,0x3E},      //9
    {0x08,0x14,0x22,0x3E,0x22,0x22,0x22,0x22},      //A
    {0x3C,0x22,0x22,0x3E,0x22,0x22,0x3C,0x00},      //B
    {0x3C,0x40,0x40,0x40,0x40,0x40,0x3C,0x00},      //C
    {0x7C,0x42,0x42,0x42,0x42,0x42,0x7C,0x00},      //D
    {0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x7C},      //E
    {0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x40},      //F
    {0x3C,0x40,0x40,0x40,0x40,0x44,0x44,0x3C},      //G
    {0x44,0x44,0x44,0x7C,0x44,0x44,0x44,0x44},      //H
    {0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x7C},      //I
    {0x3C,0x08,0x08,0x08,0x08,0x08,0x48,0x30},      //J
    {0x00,0x24,0x28,0x30,0x20,0x30,0x28,0x24},      //K
    {0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x7C},      //L
    {0x81,0xC3,0xA5,0x99,0x81,0x81,0x81,0x81},      //M
    {0x00,0x42,0x62,0x52,0x4A,0x46,0x42,0x00},      //N
    {0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C},      //O
    {0x3C,0x22,0x22,0x22,0x3C,0x20,0x20,0x20},      //P
    {0x1C,0x22,0x22,0x22,0x22,0x26,0x22,0x1D},      //Q
    {0x3C,0x22,0x22,0x22,0x3C,0x24,0x22,0x21},      //R
    {0x00,0x1E,0x20,0x20,0x3E,0x02,0x02,0x3C},      //S
    {0x00,0x3E,0x08,0x08,0x08,0x08,0x08,0x08},      //T
    {0x42,0x42,0x42,0x42,0x42,0x42,0x22,0x1C},      //U
    {0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x18},      //V
    {0x00,0x49,0x49,0x49,0x49,0x2A,0x1C,0x00},      //W
    {0x00,0x41,0x22,0x14,0x08,0x14,0x22,0x41},      //X
    {0x41,0x22,0x14,0x08,0x08,0x08,0x08,0x08},      //Y
    {0x00,0x7F,0x02,0x04,0x08,0x10,0x20,0x7F}       //Z
};

int main(void)
{
    uint8_t i, ad, ch;
    printf("Initializing......\n");
    RPi_GPIO_Init();
    MAX7219_Init();
    printf("Initialized!\n");
    delay(1000);
    while (1)
    {
        printf("Input char to display:");
        scanf("%d", &ch);
        if (ch >= 36)
            break;          //输入超过表的范围则直接退出
        for (ad = REG_DIGIT0; ad <= REG_DIGIT7; ad++)
        {
            MAX7219_Write(ad, dismap[ch][ad-1]); 
        }
        delay(1500);
    }
    return 0;
}

/**
 * @brief 树莓派这边GPIO的初始化
 *  
 */
void RPi_GPIO_Init(void)
{
    wiringPiSetup();
    pinMode(GPIO_CLK, OUTPUT);
    pinMode(GPIO_LOAD, OUTPUT);
    pinMode(GPIO_DIN, OUTPUT);
}

/**
 * @brief MAX7219相关寄存器的初始化
 *  
 */
void MAX7219_Init(void)
{
    MAX7219_Write(REG_DECODE_MODE, NO_DECODE);
    MAX7219_Write(REG_INTENSITY, LIGHT_MAX);
    MAX7219_Write(REG_SCANLIMIT, SCAN_8BIT);
    MAX7219_Write(REG_DISPLAYTEST, FORBID_TEST);
    MAX7219_Write(REG_SHUTDOWN, NORMAL_OPERATION);
}

/**
 * @brief 向MAX7219的某地址寄存器写一个字节的数据
 *  
 */
void MAX7219_Write(uint8_t addr, uint8_t data)
{
    digitalWrite(GPIO_LOAD, LOW);       //拉低LOAD，开始送16bit数据
    delayMicroseconds(1);
    MAX7219_WriteByte(addr);
    MAX7219_WriteByte(data);
    digitalWrite(GPIO_LOAD, HIGH);      //拉高LOAD，锁存16bit
    delayMicroseconds(1);
}

/**
 * @brief 向MAX7219写一个字节的数据
 *  
 */
void MAX7219_WriteByte(uint8_t data)
{
    for (int i = 1; i <= 8; i++)
    {
        digitalWrite(GPIO_CLK, LOW);
        delayMicroseconds(1);       //延时1us保证CLK速率低于10MHz
        if (data & 0X80)
            digitalWrite(GPIO_DIN, HIGH);
        else
            digitalWrite(GPIO_DIN, LOW);
        data <<= 1;
        digitalWrite(GPIO_CLK, HIGH);
        delayMicroseconds(1);
    }
}